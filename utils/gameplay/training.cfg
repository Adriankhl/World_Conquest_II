#define WORLD_CONQUEST_TEK_TRAIN_UNIT X Y RECRUITER_VAR
	[set_variables]
		name=training
		to_variable={RECRUITER_VAR}.training
	[/set_variables]
	[fire_event]
		name=wct_training_effects
		[primary_unit]
			x,y={X},{Y}
		[/primary_unit]
	[/fire_event]
#enddef

#define WORLD_CONQUEST_TEK_TRAINING_EVENT
	[event]
		name=wct_training_effects
		first_time_only=no
		{FOREACH training train_i}
			{FOREACH wct.trainer[$train_i].grade[$training[$train_i].level].chance chance_i}
				{RANDOM 0..99}
				[if]
					{VARIABLE_CONDITIONAL random less_than $wct.trainer[$train_i].grade[$training[$train_i].level].chance[$chance_i].value}
					[then]
						## generate "trained" trait description
						{VARIABLE training.trait.description "$training.trait.description|
 $wct.trainer[$train_i].grade[$training[$train_i].level].chance[$chance_i].info|"}
						## insert as code chance variables
						[insert_tag]
							name=set_variable
							variable=wct.trainer[$train_i].grade[$training[$train_i].level].chance[$chance_i].set_variable
						[/insert_tag]
						[if]
							[variable]
								name=wct.trainer[$train_i].grade[$training[$train_i].level].chance[$chance_i].event.length
								greater_than=0
							[/variable]
							[then]
								[set_variables]
									mode=append
									name=unit.event
									[insert_tag]
										name=literal
										variable=wct.trainer[$train_i].grade[$training[$train_i].level].chance[$chance_i].event
									[/insert_tag]
								[/set_variables]
							[/then]
						[/if]
						[unstore_unit]
							variable=unit
						[/unstore_unit]
						[if]
							[variable]
								name=wct.trainer[$train_i].grade[$training[$train_i].level].chance[$chance_i].effect.length
								greater_than=0
							[/variable]
							[then]
								[object]
									[filter]
										x,y=$unit.x,$unit.y
									[/filter]
									silent=yes
									duration=forever
									[insert_tag]
										name=effect
										variable=wct.trainer[$train_i].grade[$training[$train_i].level].chance[$chance_i].effect
									[/insert_tag]
								[/object]
							[/then]
						[/if]
						{INSERT_IF_EXIST modify_unit wct.trainer[$train_i].grade[$training[$train_i].level].chance[$chance_i].modify_unit}
						{INSERT_IF_EXIST fire_event wct.trainer[$train_i].grade[$training[$train_i].level].chance[$chance_i].fire_event}
						[store_unit]
							variable=unit
							[filter]
								x,y=$unit.x,$unit.y
							[/filter]
						[/store_unit]
					[/then]
				[/if]
			{NEXT chance_i}
		{NEXT train_i}
		[if]
			{VARIABLE_CONDITIONAL training.trait.length greater_than 0}
			[then]
				## give unit dummy trait "trained"
				{VARIABLE training.trait.male_name {STR_TRAINED}}
				{VARIABLE training.trait.female_name {STR_TRAINED_FEMALE}}
				[modify_unit]
					[filter]
						x,y=$unit.x,$unit.y
					[/filter]
					[insert_tag]
						name=trait
						variable=training.trait
					[/insert_tag]
				[/modify_unit]
			[/then]
		[/if]
		{CLEAR_VARIABLE training}
	[/event]
#enddef

#define WORLD_CONQUEST_TEK_TRAININGS_DESCRIPTION
	## generate info text variables for messages
	{FOREACH wct.trainer train_i}
		{FOREACH wct.trainer[$train_i].grade grade_i}
			{VARIABLE wct.trainer[$train_i].grade[$grade_i].message.caption {STR_TRAINING_FOUND_LEVEL}}
			[if]
				{VARIABLE_CONDITIONAL grade_i equals "$($wct.trainer[$train_i].grade.length-1)"}
				[then]
					{VARIABLE wct.trainer[$train_i].grade[$grade_i].message.caption {STR_TRAINING_FOUND_MAX}}
				[/then]
			[/if]
			{VARIABLE wct.trainer[$train_i].grade[$grade_i].message.message ""}
			{FOREACH wct.trainer[$train_i].grade[$grade_i].chance chance_i}
				[if]
					{VARIABLE_CONDITIONAL wct.trainer[$train_i].grade[$grade_i].chance[$chance_i].value less_than 100}
					[then]
						{VARIABLE wct.trainer[$train_i].grade[$grade_i].message.message $wct.trainer[$train_i].grade[$grade_i].message.message|+"    "+$wct.trainer[$train_i].grade[$grade_i].chance[$chance_i].value+{STR_TRAINING_CHANCE}+$wct.trainer[$train_i].grade[$grade_i].chance[$chance_i].info|+"
"}
					[/then]
					[else]
						{VARIABLE wct.trainer[$train_i].grade[$grade_i].message.message $wct.trainer[$train_i].grade[$grade_i].message.message|+"    "+$wct.trainer[$train_i].grade[$grade_i].chance[$chance_i].info|+"
"}
					[/else]
				[/if]
			{NEXT chance_i}
		{NEXT grade_i}
	{NEXT train_i}
#enddef

#define WORLD_CONQUEST_TEK_TRAINING_PLAYERS_LEVELS
	{FOREACH_FROM player 1 side_i}
	{FOREACH wct.trainer train_i}
		{VARIABLE player[$side_i].training[$train_i].level 0}
	{NEXT train_i}
	## give random bonus starting training
	[if]
		[variable]
			name=difficulty.extra_trainig
			equals=yes
		[/variable]
		[then]
			{RANDOM 1..5}
			{VARIABLE player[$side_i].training[$random].level 1}
		[/then]
	[/if]
{NEXT side_i}
#enddef

#define WORLD_CONQUEST_TEK_TRAINER_DEFINITIONS
	[trainer]
		type=Lich
		advanced_type=Ancient Lich
		image=attacks/curse.png
		name= {STR_DARK_NAME}
		dialogue= {STR_DARK_FOUND}
		[grade]
		[/grade]
		[grade]
			{WCT_CHANCE_FEEDING 3}
			{WCT_CHANCE_SP 2 MELEE PLAGUE}
			{WCT_CHANCE_SP 1 RANGED PLAGUE}
			{WCT_CHANCE_SP 1 MELEE DRAIN}
			{WCT_CHANCE_SP 1 RANGED DRAIN}
			{WCT_CHANCE_SP 1 MELEE POISON}
			{WCT_CHANCE_SP 1 RANGED POISON}
			{WCT_CHANCE_DARK_DEFENSE CAVE 7}
			{WCT_CHANCE_DARK_DEFENSE MUSHROOM 6}
		[/grade]
		[grade]
			{WCT_CHANCE_FEEDING 7}
			{WCT_CHANCE_ABILITY 2 REGENERATES}
			{WCT_CHANCE_SP 5 MELEE PLAGUE}
			{WCT_CHANCE_SP 2 RANGED PLAGUE}
			{WCT_CHANCE_SP 2 MELEE DRAIN}
			{WCT_CHANCE_SP 2 RANGED DRAIN}
			{WCT_CHANCE_SP 2 MELEE POISON}
			{WCT_CHANCE_SP 2 RANGED POISON}
			{WCT_CHANCE_DARK_DEFENSE CAVE 16}
			{WCT_CHANCE_DARK_DEFENSE MUSHROOM 13}
		[/grade]
		[grade]
			{WCT_CHANCE_FEEDING 12}
			{WCT_CHANCE_ABILITY 5 REGENERATES}
			{WCT_CHANCE_TELEPORT 1}
			{WCT_CHANCE_SP 10 MELEE PLAGUE}
			{WCT_CHANCE_SP 3 RANGED PLAGUE}
			{WCT_CHANCE_SP 4 MELEE DRAIN}
			{WCT_CHANCE_SP 3 RANGED DRAIN}
			{WCT_CHANCE_SP 3 MELEE POISON}
			{WCT_CHANCE_SP 4 RANGED POISON}
			{WCT_CHANCE_SP 1 MELEE SLOW}
			{WCT_CHANCE_SP 1 RANGED SLOW}
			{WCT_CHANCE_ARCANE_BOOST 1 MELEE}
			{WCT_CHANCE_ARCANE_BOOST 1 RANGED}
			{WCT_CHANCE_DARK_DEFENSE CAVE 29}
			{WCT_CHANCE_DARK_DEFENSE MUSHROOM 21}
		[/grade]
	[/trainer]
	[trainer]
		type=Duelist
		advanced_type=Master at Arms
		image=icons/boots_elven.png
		name= {STR_MOVEMENT_NAME}
		dialogue= {STR_MOVEMENT_FOUND}
		[grade]
		[/grade]
		[grade]
			{WCT_CHANCE_MOVEMENT 52 1}
		[/grade]
		[grade]
			{WCT_CHANCE_MOVEMENT 100 22%}
			{WCT_CHANCE_MOVE_ON_RECRUIT 11}
			{WCT_CHANCE_MOVEMENT_DEFENSE 2}
			{WCT_CHANCE_OPTIONAL_CHARGE 1}
		[/grade]
	[/trainer]
	[trainer]
		type=Orcish Warrior
		advanced_type=Orcish Warlord
		image=attacks/halberd.png
		name= {STR_MELEE_NAME}
		dialogue= {STR_MELEE_FOUND}
		[grade]
		[/grade]
		[grade]
			{WCT_CHANCE_SP 1 MELEE FIRSTSTRIKE}
			{WCT_CHANCE_DAMAGE_PER_LEVEL 4 MELEE}
			{WCT_CHANCE_DAMAGE 33 MELEE 13%}
			{WCT_CHANCE_HP 20 1}
			{WCT_CHANCE_URBAN_DEFENSE 4}
		[/grade]
		[grade]
			{WCT_CHANCE_SP 3 MELEE FIRSTSTRIKE}
			{WCT_CHANCE_SP 2 MELEE MARKSMAN}
			{WCT_CHANCE_DAMAGE 1 MELEE 2}
			{WCT_CHANCE_DAMAGE_PER_LEVEL 9 MELEE}
			{WCT_CHANCE_DAMAGE 66 MELEE 14%}
			{WCT_CHANCE_HP 44 1}
			{WCT_CHANCE_URBAN_DEFENSE 9}
		[/grade]
		[grade]
			{WCT_CHANCE_SP 7 MELEE FIRSTSTRIKE}
			{WCT_CHANCE_SP 5 MELEE MARKSMAN}
			[chance]
				value=2
				info={STR_MELEE}+": +1 "+{STR_STRIKES}
				[effect]
					apply_to=attack
					range=melee
					increase_attacks=1
				[/effect]
			[/chance]
			{WCT_CHANCE_DAMAGE 3 MELEE 2}
			{WCT_CHANCE_DAMAGE_PER_LEVEL 15 MELEE}
			{WCT_CHANCE_DAMAGE 100 MELEE 15%}
			{WCT_CHANCE_HP 72 1}
			{WCT_CHANCE_URBAN_DEFENSE 15}
		[/grade]
	[/trainer]
	[trainer]
		type=Elvish Ranger
		advanced_type=Elvish Avenger
		image=attacks/bow-elven.png
		name= {STR_RANGER_NAME}
		dialogue= {STR_RANGER_FOUND}
		[grade]
		[/grade]
		[grade]
			{WCT_CHANCES_RANGER_TERRAIN_SPECIALS 8 1}
			{WCT_CHANCE_FEARLESS 2}
			{WCT_CHANCE_ABILITY 5 AMBUSH}
			{WCT_CHANCE_ABILITY 1 NIGHTSTALK}
			{WCT_CHANCE_ABILITY 1 CONCEALMENT}
			{WCT_CHANCE_DAMAGE_PER_LEVEL 28 RANGED}
		[/grade]
		[grade]
			{WCT_CHANCES_RANGER_TERRAIN_SPECIALS 17 2}
			{WCT_CHANCE_FEARLESS 5}
			{CHANCE_WCT_ABILITY 3 DISTRACT}
			{WCT_CHANCE_ABILITY 13 AMBUSH}
			{WCT_CHANCE_ABILITY 4 NIGHTSTALK}
			{WCT_CHANCE_ABILITY 4 CONCEALMENT}
			{WCT_CHANCE_RANGED_DISENGAGE 2}
			{WCT_CHANCE_DAMAGE_PER_LEVEL 56 RANGED}
		[/grade]
		[grade]
			{WCT_CHANCES_RANGER_TERRAIN_SPECIALS 27 3}
			{WCT_CHANCE_FEARLESS 9}
			{WCT_CHANCE_BACKSTAB 2}
			{CHANCE_WCT_ABILITY 7 DISTRACT}
			{WCT_CHANCE_ABILITY 3 SKIRMISHER}
			{WCT_CHANCE_ABILITY 24 AMBUSH}
			{WCT_CHANCE_ABILITY 9 NIGHTSTALK}
			{WCT_CHANCE_ABILITY 9 CONCEALMENT}
			{WCT_CHANCE_RANGED_DISENGAGE 5}
			{WCT_CHANCE_DAMAGE_PER_LEVEL 84 RANGED}
		[/grade]
	[/trainer]
	[trainer]
		type=Drake Flare
		advanced_type=Drake Flameheart
		image=icons/letter_and_ale.png
		name= {STR_EXPERIENCE_NAME}
		dialogue= {STR_EXPERIENCE_FOUND}
		[grade]
		[/grade]
		[grade]
			{WCT_CHANCE_LEADERSHIP 1}
			{WCT_CHANCE_ABILITY 3 UNPOISON}
			{WCT_CHANCE_LOYAL 1}
			{WCT_CHANCE_XP 73 -10%}
		[/grade]
		[grade]
			{WCT_CHANCE_LEADERSHIP 3}
			{WCT_CHANCE_HEALS_UNPOISON 3}
			{WCT_CHANCE_LOYAL 2}
			{WCT_CHANCE_XP 73 -20%}
		[/grade]
		[grade]
			{WCT_CHANCE_LEADERSHIP 6}
			{WCT_CHANCE_ABILITY 3 CURES}
			{WCT_CHANCE_LOYAL 3}
			{WCT_CHANCE_XP 73 -30%}
		[/grade]
	[/trainer]
	[trainer]
		type=Dwarvish Runesmith
		advanced_type=Dwarvish Runemaster
		image=icons/cuirass_muscled.png
		name= {STR_HEALTH_NAME}
		dialogue= {STR_HEALTH_FOUND}
		[grade]
		[/grade]
		[grade]
			{CHANCE_WCT_ABILITY 5 TENACITY}
			{WCT_CHANCE_ALWAYS_REST 3}
			{WCT_CHANCE_HP_PER_LEVEL 78 1}
			{WCT_CHANCE_HP 25 2}
			{WCT_CHANCE_HP 10 10%}
		[/grade]
		[grade]
			{CHANCE_WCT_ABILITY 11 TENACITY}
			{WCT_CHANCE_ALWAYS_REST 6}
			{WCT_CHANCE_HP_PER_LEVEL 78 2}
			{WCT_CHANCE_HP 25 4}
			{WCT_CHANCE_HP 20 10%}
		[/grade]
		[grade]
			{CHANCE_WCT_ABILITY 18 TENACITY}
			{WCT_CHANCE_ALWAYS_REST 9}
			{WCT_CHANCE_HP_PER_LEVEL 78 3}
			{WCT_CHANCE_HP 25 6}
			{WCT_CHANCE_HP 30 10%}
		[/grade]
	[/trainer]
#enddef

## chance Macros
## unit with already trait, abilty or special gets +1 HP

#define WCT_CHANCE_RANGED_DISENGAGE CHANCE
	[chance]
		value={CHANCE}
		info={STR_RANGED}+": "+{STR_DISENGAGE}
		[effect]
			apply_to=attack
			range=ranged
			{WCT_WEAPON_SPECIAL_DISENGAGE}
		[/effect]
		{WCT_DISENGAGE_EVENT}
	[/chance]
#enddef

#define WCT_WEAPON_SPECIAL_DISENGAGE
	[set_specials]
		mode=append
		[dummy]
			id=disengage
			name= {STR_DISENGAGE}
			description= {STR_DISENGAGE_DESCRIPTION}
		[/dummy]
	[/set_specials]
#enddef

#define WCT_DISENGAGE_EVENT
	[event]
		name=attack end
		first_time_only=no
		id=wct_disengage_attack
		[filter_attack]
			special=disengage
		[/filter_attack]
		[modify_unit]
			[filter]
				x,y=$unit.x,$unit.y
			[/filter]
			moves=1
		[/modify_unit]
	[/event]
#enddef

#define WCT_CHANCE_MOVE_ON_RECRUIT CHANCE
	[chance]
		value={CHANCE}
		info={STR_MOVE_ON_RECRUIT}
		{VARIABLE unit.variables.move_on_recruit yes}
		{VARIABLE unit.moves $unit.max_moves}
		{VARIABLE unit.attacks_left 1}
		[event]
			name=recall
			first_time_only=no
			id=wct_move_on_recruit
			[filter]
				[filter_wml]
					[variables]
						move_on_recruit=yes
					[/variables]
				[/filter_wml]
			[/filter]
			{VARIABLE unit.moves $unit.max_moves}
			{VARIABLE unit.attacks_left 1}
			[unstore_unit]
				variable=unit
			[/unstore_unit]
		[/event]
	[/chance]
#enddef

#define WCT_ALWAYS_REST
	{VARIABLE unit.variables.always_rest yes}
	[event]
		name=side turn
		first_time_only=no
		id=always_rest
		[modify_unit]
			[filter]
				[filter_wml]
					[variables]
						always_rest=yes
					[/variables]
				[/filter_wml]
			[/filter]
			resting=yes
		[/modify_unit]
	[/event]
#enddef

#define WCT_CHANCE_ALWAYS_REST CHANCE
	[chance]
		value={CHANCE}
		info={STR_ALWAYS_REST}
		[effect]
			[filter]
				[filter_wml]
					[modifications]
						[trait]
							id=healthy
						[/trait]
					[/modifications]
				[/filter_wml]
			[/filter]
			apply_to=hitpoints
			increase_total=1
			heal_full=yes
		[/effect]
		{WCT_ALWAYS_REST}
	[/chance]
#enddef

#define WCT_CHANCE_FEARLESS CHANCE
	## using unit.role, wich is dirty :/
	## (but couldnt find a better way using modify_unit)
	[chance]
		value={CHANCE}
		info={STR_FEARLESS}
		[effect]
			[filter]
				[filter_wml]
					[modifications]
						[trait]
							id=fearless
						[/trait]
					[/modifications]
				[/filter_wml]
				[not]
					role=wct_fearless
				[/not]
				[or]
					[filter_wml]
						alignment=neutral
					[/filter_wml]
				[/or]
			[/filter]
			apply_to=hitpoints
			increase_total=1
			heal_full=yes
		[/effect]
		[modify_unit]
			[filter]
				x,y=$unit.x,$unit.y
				[not]
					[filter_wml]
						[modifications]
							[trait]
								id=fearless
							[/trait]
						[/modifications]
					[/filter_wml]
					[or]
						[filter_wml]
							alignment=neutral
						[/filter_wml]
					[/or]
				[/not]
			[/filter]
			{TRAIT_FEARLESS}
			role=wct_fearless
		[/modify_unit]
	[/chance]
#enddef

#define WCT_CHANCE_SP CHANCE RANGE SPECIAL
	[chance]
		value={CHANCE}
		info={STR_{RANGE}}+": "+{STR_{SPECIAL}}
		[effect]
			[filter]
				[filter_wml]
					[attack]
						range={STR_ID_{RANGE}}
						[specials]
							{WEAPON_SPECIAL_{SPECIAL}}
						[/specials]
					[/attack]
				[/filter_wml]
			[/filter]
			apply_to=hitpoints
			increase_total=1
			heal_full=yes
		[/effect]
		[effect]
			apply_to=attack
			range={STR_ID_{RANGE}}
			remove_specials={STR_ID_{SPECIAL}}
			[set_specials]
				mode=append
				{WEAPON_SPECIAL_{SPECIAL}}
			[/set_specials]
		[/effect]
	[/chance]
#enddef

#define WCT_CHANCE_ABILITY CHANCE ABILITY
	[chance]
		value={CHANCE}
		info={STR_{ABILITY}}
		[effect]
			[filter]
				ability={STR_ID_{ABILITY}}
			[/filter]
			apply_to=hitpoints
			increase_total=1
			heal_full=yes
		[/effect]
		## must remove heals +4 in order to apply heals +8
		[effect]
			apply_to=remove_ability
			[abilities]
				[{STR_TAG_{ABILITY}}]
					id={STR_ID_{ABILITY}}
				[/{STR_TAG_{ABILITY}}]
			[/abilities]
		[/effect]
		[effect]
			apply_to=new_ability
			[abilities]
				{ABILITY_{ABILITY}}
			[/abilities]
		[/effect]
	[/chance]
#enddef

#define CHANCE_WCT_ABILITY CHANCE ABILITY
	[chance]
		value={CHANCE}
		info={STR_{ABILITY}}
		[effect]
			apply_to=new_ability
			[abilities]
				{WCT_ABILITY_{ABILITY}}
			[/abilities]
		[/effect]
	[/chance]
#enddef

#define WCT_ABILITY_DISTRACT
	[skirmisher]
		id=distract
		name= {STR_DISTRACT}
		female_name= {STR_DISTRACT}
		description= {STR_DISTRACT_DESCRIPTION}
		affect_self=no
		affect_allies=yes
		[affect_adjacent]
			adjacent=n,ne,se,s,sw,nw
			[filter]
				[not]
					id=$unit.id
				[/not]
			[/filter]
		[/affect_adjacent]
	[/skirmisher]
#enddef

#define WCT_ABILITY_TENACITY
	[resistance]
		id=tenacity
		divide=2
		max_value=0
		[filter_base_value]
			less_than=0
		[/filter_base_value]
		name= {STR_TENACITY}
		female_name= {STR_TENACITY}
		description= {STR_TENACITY_DESCRIPTION}
		affect_self=yes
		active_on=defense
	[/resistance]
#enddef

#define WCT_CHANCE_BACKSTAB CHANCE
	[chance]
		value={CHANCE}
		info={STR_BACKSTAB}
		[effect]
			[filter]
				[filter_wml]
					[attack]
						[specials]
							{WEAPON_SPECIAL_BACKSTAB}
						[/specials]
					[/attack]
				[/filter_wml]
			[/filter]
			apply_to=hitpoints
			increase_total=1
			heal_full=yes
		[/effect]
		[effect]
			apply_to=attack
			remove_specials=backstab
			[set_specials]
				mode=append
				{WEAPON_SPECIAL_BACKSTAB}
			[/set_specials]
		[/effect]
	[/chance]
#enddef

#define WCT_CHANCE_HEALS_UNPOISON CHANCE
	[chance]
		value={CHANCE}
		info={STR_HEALS_UNPOISON}
		[effect]
			[filter]
				ability=healing
			[/filter]
			apply_to=hitpoints
			increase_total=1
			heal_full=yes
		[/effect]
		[effect]
			apply_to=new_ability
			[abilities]
				{ABILITY_HEALS}
				{ABILITY_UNPOISON}
			[/abilities]
		[/effect]
	[/chance]
#enddef

#define WCT_FEEDING
	[effect]
		apply_to=new_ability
		[abilities]
			[dummy]
				id=feeding
				name= {STR_FEEDING}
				female_name= {STR_FEEDING}
				description= {STR_FEEDING_DESCRIPTION}
			[/dummy]
		[/abilities]
	[/effect]
	[event]
		id=ability_feeding_die
		name=die
		first_time_only=no
		[filter]
			[not]
				[filter_wml]
					[status]
						not_living="yes"
					[/status]
				[/filter_wml]
			[/not]
		[/filter]
		[filter_second]
			ability=feeding
		[/filter_second]
		[unstore_unit]
			variable=second_unit
			{COLOR_HEAL}
			text= {STR_FEEDING_EFFECT}
			find_vacant=no
		[/unstore_unit]
		[object]
			silent=yes
			duration=forever
			[filter]
				x,y=$x2,$y2
			[/filter]
			[effect]
				apply_to=hitpoints
				increase_total=1
				increase=1
			[/effect]
		[/object]
	[/event]
#enddef

#define WCT_CHANCE_FEEDING CHANCE
	[chance]
		value={CHANCE}
		info={STR_FEEDING}
		[effect]
			[filter]
				ability=feeding
			[/filter]
			apply_to=hitpoints
			increase_total=1
			heal_full=yes
		[/effect]
		{WCT_FEEDING}
	[/chance]
#enddef

#define WCT_LEADERSHIP_X LEVEL
	[effect]
		[filter]
			level={LEVEL}
		[/filter]
		apply_to=new_ability
		[abilities]
			{ABILITY_LEADERSHIP_LEVEL_{LEVEL}}
		[/abilities]
	[/effect]
#enddef

#define WCT_CHANCE_LEADERSHIP CHANCE
	[chance]
		value={CHANCE}
		info={STR_LEADERSHIP}
		[effect]
			[filter]
				ability=leadership
			[/filter]
			apply_to=hitpoints
			increase_total=1
			heal_full=yes
		[/effect]
		{WCT_LEADERSHIP_X 1}
		{WCT_LEADERSHIP_X 2}
		{WCT_LEADERSHIP_X 3}
		{WCT_LEADERSHIP_X 4}
	[/chance]
#enddef

#define WCT_CHANCE_MOVEMENT CHANCE BOOST
	[chance]
		value={CHANCE}
		info="+{BOOST} "+{STR_MOVES}
		[effect]
			apply_to=movement
			increase={BOOST}
		[/effect]
	[/chance]
#enddef

#define WCT_CHANCE_DAMAGE CHANCE RANGE BOOST
	[chance]
		value={CHANCE}
		info={STR_{RANGE}}+": +{BOOST} "+{STR_DAMAGE}
		[effect]
			apply_to=attack
			range={STR_ID_{RANGE}}
			increase_damage={BOOST}
		[/effect]
	[/chance]
#enddef

#define WCT_CHANCE_DAMAGE_PER_LEVEL CHANCE RANGE
	[chance]
		value={CHANCE}
		info={STR_{RANGE}}+": +1 "+{STR_DAMAGE}+" "+{STR_PER_LEVEL}
		[effect]
			apply_to=attack
			range={STR_ID_{RANGE}}
			increase_damage=1
			times=per level
		[/effect]
	[/chance]
#enddef

#define WCT_CHANCE_HP CHANCE HP
	[chance]
		value={CHANCE}
		info="+{HP} "+{STR_HITPOINTS}
		[effect]
			apply_to=hitpoints
			increase_total={HP}
			heal_full=yes
		[/effect]
	[/chance]
#enddef

#define WCT_CHANCE_HP_PER_LEVEL CHANCE HP
	[chance]
		value={CHANCE}
		info="+{HP} "+{STR_HITPOINTS}+" "{STR_PER_LEVEL}
		[effect]
			apply_to=hitpoints
			times=per level
			increase_total={HP}
			heal_full=yes
		[/effect]
	[/chance]
#enddef

#define WCT_CHANCE_XP CHANCE VALUE
	[chance]
		value={CHANCE}
		info="{VALUE} "+{STR_EXPERIENCE}
		[effect]
			apply_to=max_experience
			increase={VALUE}
		[/effect]
	[/chance]
#enddef

#define WCT_CHANCE_LOYAL CHANCE
	[chance]
		value={CHANCE}
		info={STR_FREE_UPKEEP}
		{VARIABLE unit.upkeep loyal}
	[/chance]
#enddef

#define WCT_CHANCE_URBAN_DEFENSE CHANCE
	[chance]
		value={CHANCE}
		info={STR_VILLAGE}+"/"+{STR_CASTLE}+": +5 "+{STR_DEFENSE}
		[effect]
			apply_to=defense
			replace=false
			[defense]
				village=-5
				castle=-5
			[/defense]
		[/effect]
	[/chance]
#enddef

#define WCT_WILD_DEFENSE TERRAIN DEF
	[effect]
		apply_to=defense
		replace=false
		[defense]
			{STR_ID_{TERRAIN}}=-{DEF}
		[/defense]
	[/effect]
	[effect]
		apply_to=movement_costs
		replace=true
		[movement_costs]
			{STR_ID_{TERRAIN}}=1
		[/movement_costs]
	[/effect]
#enddef

#define WCT_CHANCE_RANGER_SP CHANCE TERRAIN DEF DMG_TYPE RES
	[chance]
		value={CHANCE}
		info={STR_{TERRAIN}}+": +"+{DEF}+" "+{STR_DEFENSE}+{STR_AND}+{STR_FULL_MOVEMENT}+", +"+{RES}+{STR_RESISTANCE}+{STR_{DMG_TYPE}}
		{WCT_WILD_DEFENSE {TERRAIN} {DEF}}
		[effect]
			apply_to=resistance
			replace=false
			[resistance]
				{STR_ID_{DMG_TYPE}}=-{RES}
			[/resistance]
		[/effect]
	[/chance]
#enddef

#define WCT_CHANCES_RANGER_TERRAIN_SPECIALS CHANCE GRADE
	{WCT_CHANCE_RANGER_SP {CHANCE} FOREST "$(5+{GRADE})" PIERCE "$(8+{GRADE})"}
	{WCT_CHANCE_RANGER_SP {CHANCE} HILLS "$(5+{GRADE})" IMPACT "$(8+{GRADE})"}
	{WCT_CHANCE_RANGER_SP {CHANCE} SWAMP "$(5+{GRADE})" BLADE "$(8+{GRADE})"}
	{WCT_CHANCE_RANGER_SP {CHANCE} SAND "$(5+{GRADE})" FIRE "$(8+{GRADE})"}
	{WCT_CHANCE_RANGER_SP {CHANCE} FROZEN "$(8+2*{GRADE}+{GRADE}/3)" COLD "$(8+4*{GRADE})"}
#enddef

#define WCT_CHANCE_DARK_DEFENSE TERRAIN CHANCE
	[chance]
		value={CHANCE}
		info={STR_{TERRAIN}}+": +10 "+{STR_DEFENSE}+{STR_AND}+{STR_FULL_MOVEMENT}
		{WCT_WILD_DEFENSE {TERRAIN} 10}
	[/chance]
#enddef

#define WCT_CHANCE_MOVEMENT_DEFENSE CHANCE
	[chance]
		value={CHANCE}
		info="+"+{STR_MOVES}+" "+{STR_DEFENSE}
		[event]
			id=wct_movement_boost_defenses
			name=wct_movement_boost_defenses
			first_time_only=no
			[object]
				duration=forever
				silent=yes
				[filter]
					x,y=$unit.x,$unit.y
				[/filter]
				[effect]
					[filter]
						level=$unit.level
					[/filter]
					apply_to=defense
					replace=false
					[defense]
						fungus=-$unit.max_moves
						cave=-$unit.max_moves
						deep_water=-$unit.max_moves
						shallow_water=-$unit.max_moves
						swamp_water=-$unit.max_moves
						flat=-$unit.max_moves
						sand=-$unit.max_moves
						forest=-$unit.max_moves
						hills=-$unit.max_moves
						mountains=-$unit.max_moves
						village=-$unit.max_moves
						castle=-$unit.max_moves
						frozen=-$unit.max_moves
						unwalkable=-$unit.max_moves
						reef=-$unit.max_moves
					[/defense]
				[/effect]
			[/object]
		[/event]
		{WCT_ADVANCE_FIRE_EVENT movement_boost defenses}
	[/chance]
#enddef

#define WCT_CHANCE_OPTIONAL_CHARGE CHANCE
	[chance]
		value={CHANCE}
		info={STR_MELEE}+": "+{STR_OPTIONAL_CHARGE}
		[effect]
			apply_to=attack
			range=melee
			remove_specials=charge
		[/effect]
		[event]
			id=wct_optional_charge_attacks
			name=wct_optional_charge_attacks
			first_time_only=no
			[object]
				duration=forever
				silent=yes
				[filter]
					x,y=$unit.x,$unit.y
				[/filter]
				[effect]
					apply_to=remove_attacks
					range=ranged
				[/effect]
				[effect]
					apply_to=attack
					[set_specials]
						mode=append
						{WEAPON_SPECIAL_CHARGE}
					[/set_specials]
				[/effect]
			[/object]
			[store_unit]
				variable=temp_unit
				[filter]
					x,y=$unit.x,$unit.y
				[/filter]
			[/store_unit]
			[set_variables]
				mode=append
				name=unit.attack
				to_variable=temp_unit.attack
			[/set_variables]
			{CLEAR_VARIABLE temp_unit}
			## avoid fire on AMLA
			[if]
				[variable]
					name=unit.advances_to
					equals=$null
				[/variable]
				[then]
					{CLEAR_VARIABLE unit.variables.optional_charge}
				[/then]
			[/if]
			[unstore_unit]
				variable=unit
			[/unstore_unit]
		[/event]
		{WCT_ADVANCE_FIRE_EVENT optional_charge attacks}
	[/chance]
#enddef

#define WCT_CHANCE_ARCANE_BOOST CHANCE RANGE
	[chance]
		value={CHANCE}
		info={STR_{RANGE}}+": "+{STR_ARCANE}+{STR_AND}+"+25% "+{STR_DAMAGE}
		[effect]
			[filter]
				[filter_wml]
					[attack]
						range={STR_ID_{RANGE}}
						type=arcane
					[/attack]
				[/filter_wml]
			[/filter]
			apply_to=hitpoints
			increase_total=1
			heal_full=yes
		[/effect]
		[effect]
			apply_to=attack
			range={STR_ID_{RANGE}}
			set_type=arcane
			increase_damage=25%
		[/effect]
	[/chance]
#enddef

#define WCT_CHANCE_TELEPORT CHANCE
	[chance]
		value={CHANCE}
		info={STR_TELEPORT}
		[effect]
			[filter]
				ability=teleport
			[/filter]
			apply_to=hitpoints
			increase_total=1
			heal_full=yes
		[/effect]
		{WCT_TELEPORT_OBJECT}
	[/chance]
#enddef

#define WCT_TELEPORT_OBJECT
	[object]
		silent=yes
		duration=forever
		delayed_variable_substitution=yes ##fix teleport, etc. bug in Wesnoth 1.10
		[filter]
			x,y=$unit.x,$unit.y
		[/filter]
		[effect]
			apply_to=new_ability
			[abilities]
				{ABILITY_TELEPORT}
			[/abilities]
		[/effect]
		[effect]
			apply_to=new_animation
			[animation]
				apply_to=pre_teleport
				{TELEPORT_OUT_ANIMATION}
			[/animation]
			[animation]
				apply_to=post_teleport
				{TELEPORT_IN_ANIMATION}
			[/animation]
		[/effect]
	[/object]
#enddef

#define WCT_ADVANCE_FIRE_EVENT VAR NAME
	## handle effects that must be reapplied after unit advances
	## real effect is coded in an event written in artifact or training; this macro fires that event, and write a control variable to fire again when leveling
	{VARIABLE unit.variables.{VAR} yes}
	[fire_event]
		name=wct_{VAR}_{NAME}
		[primary_unit]
			x,y=$unit.x,$unit.y
		[/primary_unit]
	[/fire_event]
	[event]
		id=wct_{VAR}_advances
		name=post advance
		first_time_only=no
		[filter]
			[filter_wml]
				[variables]
					{VAR}=yes
				[/variables]
			[/filter_wml]
		[/filter]
		[fire_event]
			name=wct_{VAR}_{NAME}
			[primary_unit]
				x,y=$unit.x,$unit.y
			[/primary_unit]
		[/fire_event]
	[/event]
#enddef
