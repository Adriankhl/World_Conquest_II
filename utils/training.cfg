#define WORLD_CONQUEST_TEK_TRAIN_UNIT RECRUITER_VAR
[set_variables]
    name=training
    to_variable={RECRUITER_VAR}.training
[/set_variables]
[fire_event]
    name=wct_training_effects
    [primary_unit]
        x,y=$unit.x,$unit.y
    [/primary_unit]
[/fire_event]
#enddef

#define WORLD_CONQUEST_TEK_TRAINING_EVENT
[event]
    name=wct_training_effects
    first_time_only=no
    {FOREACH training train_i}
        {FOREACH wct.trainer[$train_i].grade[$training[$train_i].level].chance chance_i}
            {RANDOM 0..99}
            [if]
                {VARIABLE_CONDITIONAL random less_than $wct.trainer[$train_i].grade[$training[$train_i].level].chance[$chance_i].value}
            [then]
                ## generate "trained" trait description
                {VARIABLE training.trait.description "$training.trait.description|
 $wct.trainer[$train_i].grade[$training[$train_i].level].chance[$chance_i].info|"}
                ## insert as code chance variables
                [insert_tag]
                    name=set_variable
                    variable=wct.trainer[$train_i].grade[$training[$train_i].level].chance[$chance_i].set_variable
                [/insert_tag]
                [set_variables]
                    mode=append
                    name=unit.event
                    [insert_tag]
                        name=literal
                        variable=wct.trainer[$train_i].grade[$training[$train_i].level].chance[$chance_i].event
                    [/insert_tag]
                [/set_variables]
                [unstore_unit]
                    variable=unit
                [/unstore_unit]
                [object]
                    [filter]
                        x,y=$unit.x,$unit.y
                    [/filter]
                    silent=yes
                    duration=forever
                    [insert_tag]
                        name=effect
                        variable=wct.trainer[$train_i].grade[$training[$train_i].level].chance[$chance_i].effect
                    [/insert_tag]				
                [/object]	
                [insert_tag]
                    name=if
                    variable=wct.trainer[$train_i].grade[$training[$train_i].level].chance[$chance_i].if
                [/insert_tag]
                {INSERT_IF_EXIST modify_unit wct.trainer[$train_i].grade[$training[$train_i].level].chance[$chance_i].modify_unit}
                [store_unit]
                    variable=unit
                    [filter]
                        x,y=$unit.x,$unit.y
                    [/filter]
                [/store_unit]
                {INSERT_IF_EXIST fire_event wct.trainer[$train_i].grade[$training[$train_i].level].chance[$chance_i].fire_event}
            [/then]
            [/if]
        {NEXT chance_i}
    {NEXT train_i}
    [if]
        {VARIABLE_CONDITIONAL training.trait.length greater_than 0}
    [then]
        [unstore_unit]
            variable=unit
        [/unstore_unit]
        ## give unit dummy trait "trained"
        {VARIABLE training.trait.male_name {STR_TRAINED}}
        {VARIABLE training.trait.female_name {STR_TRAINED_FEMALE}}
        [modify_unit]
            [filter]
                x,y=$unit.x,$unit.y
            [/filter]
            [insert_tag]
                name=trait
                variable=training.trait
            [/insert_tag]
        [/modify_unit]
    [/then]
    [/if]
    {CLEAR_VARIABLE training}
[/event]	
#enddef

#define WORLD_CONQUEST_TEK_TRAININGS_DESCRIPTION
## generate info text variables for messages
{FOREACH wct.trainer train_i}
    {FOREACH wct.trainer[$train_i].grade grade_i}
        {VARIABLE wct.trainer[$train_i].grade[$grade_i].message.caption {STR_TRAINING_FOUND_LEVEL}}
        [if]
            {VARIABLE_CONDITIONAL grade_i equals "$($wct.trainer[$train_i].grade.length-1)"}
        [then]
            {VARIABLE wct.trainer[$train_i].grade[$grade_i].message.caption {STR_TRAINING_FOUND_MAX}}
        [/then]
        [/if]
        {VARIABLE wct.trainer[$train_i].grade[$grade_i].message.message ""}
        {FOREACH wct.trainer[$train_i].grade[$grade_i].chance chance_i}
            [if]
                {VARIABLE_CONDITIONAL wct.trainer[$train_i].grade[$grade_i].chance[$chance_i].value less_than 100}
            [then]
                {VARIABLE wct.trainer[$train_i].grade[$grade_i].message.message $wct.trainer[$train_i].grade[$grade_i].message.message|+"    "+$wct.trainer[$train_i].grade[$grade_i].chance[$chance_i].value+{STR_TRAINING_CHANCE}+$wct.trainer[$train_i].grade[$grade_i].chance[$chance_i].info|+" 
"}
            [/then]
            [else]
                {VARIABLE wct.trainer[$train_i].grade[$grade_i].message.message $wct.trainer[$train_i].grade[$grade_i].message.message|+"    "+$wct.trainer[$train_i].grade[$grade_i].chance[$chance_i].info|+" 
"}
            [/else]
            [/if]
        {NEXT chance_i}
    {NEXT grade_i}
{NEXT train_i}
#enddef

#define WORLD_CONQUEST_TEK_TRAINING_PLAYERS_LEVELS
{FOREACH_FROM player 1 side_i}
    {FOREACH wct.trainer train_i}
        {VARIABLE player[$side_i].training[$train_i].level 0}
    {NEXT train_i}
    ## give random bonus starting training
    [if]
        [variable]
            name=difficulty.extra_trainig
            equals=yes
        [/variable]
    [then]
        {RANDOM 0..4}
        {VARIABLE player[$side_i].training[$random].level 1}
    [/then]
    [/if]
{NEXT side_i}
#enddef

#define WORLD_CONQUEST_TEK_TRAINER_DEFINITIONS
[trainer]
    type=Orcish Warrior
    advanced_type=Orcish Warlord
    image=attacks/halberd.png
    name= {STR_MELEE_NAME}
    dialogue= {STR_MELEE_FOUND}
    [grade]
    [/grade]
    [grade]
        {WCT_CHANCE_DAMAGE_PER_LEVEL 4 MELEE}
        {WCT_CHANCE_DAMAGE_PER_CENT 33 MELEE 13}
        {WCT_CHANCE_HP 20 1}
        {WCT_CHANCE_URBAN_DEFENSE 4}
        {WCT_CHANCE_SP 1 MELEE FIRSTSTRIKE}
    [/grade]
    [grade]
        {WCT_CHANCE_DAMAGE 1 MELEE 2}
        {WCT_CHANCE_DAMAGE_PER_LEVEL 9 MELEE}
        {WCT_CHANCE_DAMAGE_PER_CENT 66 MELEE 14}
        {WCT_CHANCE_HP 45 1}
        {WCT_CHANCE_URBAN_DEFENSE 9}
        {WCT_CHANCE_SP 3 MELEE FIRSTSTRIKE}
        {WCT_CHANCE_SP 2 MELEE MARKSMAN}
    [/grade]
    [grade]
        {WCT_CHANCE_DAMAGE 3 MELEE 2}
        {WCT_CHANCE_DAMAGE_PER_LEVEL 15 MELEE}
        {WCT_CHANCE_DAMAGE_PER_CENT 100 MELEE 15}
        {WCT_CHANCE_HP 80 1}
        {WCT_CHANCE_URBAN_DEFENSE 15}
        {WCT_CHANCE_SP 7 MELEE FIRSTSTRIKE}
        {WCT_CHANCE_SP 5 MELEE MARKSMAN}
        [chance]
            value=1
            info={STR_MELEE}+": +1 "+{STR_STRIKES}
            [effect]
                apply_to=attack
                range=melee
                increase_attacks=1
            [/effect]
        [/chance]
    [/grade]
[/trainer]
[trainer]
    type=Elvish Ranger
    advanced_type=Elvish Avenger
    image=attacks/bow-elven.png
    name= {STR_RANGER_NAME}
    dialogue= {STR_RANGER_FOUND}
    [grade]
    [/grade]
    [grade]
        {WCT_CHANCE_DAMAGE_PER_LEVEL 6 RANGED}
        {WCT_CHANCE_DAMAGE_PER_CENT 30 RANGED 13}
        {WCT_CHANCE_ABILITY 8 AMBUSH}
        {WCT_CHANCES_RANGER_TERRAIN_SPECIALS 7 1}
        {WCT_CHANCE_FEARLESS 2}
        {WCT_CHANCE_ABILITY 1 NIGHTSTALK}
    [/grade]
    [grade]
        {WCT_CHANCE_DAMAGE_PER_LEVEL 13 RANGED}
        {WCT_CHANCE_DAMAGE_PER_CENT 60 RANGED 14}
        {WCT_CHANCE_ABILITY 20 AMBUSH}
        {WCT_CHANCES_RANGER_TERRAIN_SPECIALS 16 2}
        {WCT_CHANCE_FEARLESS 5}
        {WCT_CHANCE_ABILITY 3 NIGHTSTALK}
        {WCT_CHANCE_ABILITY 2 SKIRMISHER}
        {WCT_CHANCE_BACKSTAB 2}
    [/grade]
    [grade]
        {WCT_CHANCE_DAMAGE_PER_LEVEL 22 RANGED}
        {WCT_CHANCE_DAMAGE_PER_CENT 90 RANGED 15}
        {WCT_CHANCE_ABILITY 50 AMBUSH}
        {WCT_CHANCES_RANGER_TERRAIN_SPECIALS 27 3}
        {WCT_CHANCE_FEARLESS 9}
        {WCT_CHANCE_ABILITY 7 NIGHTSTALK}
        {WCT_CHANCE_ABILITY 5 SKIRMISHER}
        {WCT_CHANCE_BACKSTAB 5}
    [/grade]
[/trainer]
[trainer]
    type=Dwarvish Runesmith
    advanced_type=Dwarvish Runemaster
    image=icons/cuirass_muscled.png
    name= {STR_HEALTH_NAME}
    dialogue= {STR_HEALTH_FOUND}
    [grade]
    [/grade]
    [grade]
        {WCT_CHANCE_HP_PER_LEVEL 80 1}
        {WCT_CHANCE_HP 25 2}
        {WCT_CHANCE_HP_PER_CENT 10}
        {WCT_CHANCE_ALWAYS_REST 3}
    [/grade]
    [grade]
        {WCT_CHANCE_HP_PER_LEVEL 80 2}
        {WCT_CHANCE_HP 25 4}
        {WCT_CHANCE_HP_PER_CENT 20}
        {WCT_CHANCE_ALWAYS_REST 6}
    [/grade]
    [grade]
        {WCT_CHANCE_HP_PER_LEVEL 80 3}
        {WCT_CHANCE_HP 25 6}
        {WCT_CHANCE_HP_PER_CENT 30}
        {WCT_CHANCE_ALWAYS_REST 9}
    [/grade]
[/trainer]
[trainer]
    type=Duelist
    advanced_type=Master at Arms
    image=icons/boots_elven.png
    name= {STR_MOVEMENT_NAME}
    dialogue= {STR_MOVEMENT_FOUND}
    [grade]
    [/grade]
    [grade]
        [chance]
            value=55
            info="+1 "+{STR_MOVES}
            [effect]
                apply_to=movement
                increase=1
            [/effect]
        [/chance]
    [/grade]
    [grade]
        [chance]
            value=100
            info="+22% "+{STR_MOVES}
            [effect]
                apply_to=movement
                increase=22%
            [/effect]
        [/chance]
        {WCT_CHANCE_MOVE_ON_RECRUIT 11}
        {WCT_CHANCE_MOVEMENT_DEFENSE 2}
        {WCT_CHANCE_OPTIONAL_CHARGE 1}
    [/grade]
[/trainer]
[trainer]
    type=Drake Flare
    advanced_type=Drake Flameheart
    image=icons/letter_and_ale.png
    name= {STR_EXPERIENCE_NAME}
    dialogue= {STR_EXPERIENCE_FOUND}
    [grade]
    [/grade]
    [grade]
        {WCT_CHANCE_XP 75 -10%}
        {WCT_CHANCE_LEADERSHIP 1}
    [/grade]
    [grade]
        {WCT_CHANCE_XP 75 -20%}
        {WCT_CHANCE_LEADERSHIP 3}
        {WCT_CHANCE_ABILITY 2 HEALS}
    [/grade]
    [grade]
        {WCT_CHANCE_XP 75 -30%}
        {WCT_CHANCE_LEADERSHIP 6}
        {WCT_CHANCE_ABILITY 5 HEALS}
    [/grade]
[/trainer]
[trainer]
    type=Lich
    advanced_type=Ancient Lich
    image=attacks/curse.png
    name= {STR_DARK_NAME}
    dialogue= {STR_DARK_FOUND}
    [grade]
    [/grade]
    [grade]
        {WCT_CHANCES_DARK_DEFENSES 5}
        {WCT_CHANCE_FEEDING 3}
        {WCT_CHANCE_SP 1 MELEE PLAGUE}
        {WCT_CHANCE_SP 1 RANGED PLAGUE}
        {WCT_CHANCE_SP 1 MELEE DRAIN}
        {WCT_CHANCE_SP 1 RANGED DRAIN}
        {WCT_CHANCE_SP 1 MELEE POISON}
        {WCT_CHANCE_SP 1 RANGED POISON}
    [/grade]
    [grade]
        {WCT_CHANCES_DARK_DEFENSES 11}
        {WCT_CHANCE_FEEDING 7}
        {WCT_CHANCE_SP 2 MELEE PLAGUE}
        {WCT_CHANCE_SP 2 RANGED PLAGUE}
        {WCT_CHANCE_SP 2 MELEE DRAIN}
        {WCT_CHANCE_SP 2 RANGED DRAIN}
        {WCT_CHANCE_SP 2 MELEE POISON}
        {WCT_CHANCE_SP 2 RANGED POISON}
        {WCT_CHANCE_ABILITY 2 REGENERATES}
    [/grade]
    [grade]
        {WCT_CHANCES_DARK_DEFENSES 18}
        {WCT_CHANCE_FEEDING 12}
        {WCT_CHANCE_SP 4 MELEE PLAGUE}
        {WCT_CHANCE_SP 4 RANGED PLAGUE}
        {WCT_CHANCE_SP 4 MELEE DRAIN}
        {WCT_CHANCE_SP 4 RANGED DRAIN}
        {WCT_CHANCE_SP 4 MELEE POISON}
        {WCT_CHANCE_SP 4 RANGED POISON}
        {WCT_CHANCE_ABILITY 4 REGENERATES}
        {WCT_CHANCE_SP 1 MELEE SLOW}
        {WCT_CHANCE_SP 1 RANGED SLOW}
        {WCT_CHANCE_ARCANE_BOOST 1 MELEE}
        {WCT_CHANCE_ARCANE_BOOST 1 RANGED}
    [/grade]
[/trainer]
#enddef

## chance Macros
## unit with already trait, abilty or special gets +1 HP

#define WCT_CHANCE_MOVE_ON_RECRUIT CHANCE
[chance]
    value={CHANCE}
    info={STR_MOVE_ON_RECRUIT}
    {VARIABLE unit.variables.move_on_recruit yes}
    {VARIABLE unit.moves $unit.max_moves}
    {VARIABLE unit.attacks_left 1}
    [event]
        name=recall
        first_time_only=no
        id=wct_move_on_recruit
        [filter]
            [filter_wml]
                [variables]
                    move_on_recruit=yes
                [/variables]
            [/filter_wml]
        [/filter]
        {VARIABLE unit.moves $unit.max_moves}
        {VARIABLE unit.attacks_left 1}
        [unstore_unit]
            variable=unit
        [/unstore_unit]
    [/event]
[/chance]
#enddef

#define WCT_ALWAYS_REST
{VARIABLE unit.variables.always_rest yes}
[event]
    name=side turn
    first_time_only=no
    id=always_rest
    [modify_unit]
        [filter]
            [filter_wml]
                [variables]
                    always_rest=yes
                [/variables]
            [/filter_wml]
        [/filter]
        resting=yes
    [/modify_unit]
[/event]
#enddef

#define WCT_CHANCE_ALWAYS_REST CHANCE
[chance]
    value={CHANCE}
    info={STR_ALWAYS_REST}
    [effect]
        [filter]
            [filter_wml]
                [modifications]
                    [trait]
                        id=healthy
                    [/trait]
                [/modifications]
            [/filter_wml]
        [/filter]
        apply_to=hitpoints
        increase_total=1
        heal_full=yes
    [/effect]
    {WCT_ALWAYS_REST}
[/chance]
#enddef

#define WCT_CHANCE_FEARLESS CHANCE
## using unit.role, wich is dirty :/
## (but couldnt find a better way using modify_unit)
[chance]
    value={CHANCE}
    info={STR_FEARLESS}
    [effect]
        [filter]
            [filter_wml]
                [modifications]
                    [trait]
                        id=fearless
                    [/trait]
                [/modifications]
            [/filter_wml]
            [not]
                role=wct_fearless
            [/not]
            [or]
                [filter_wml]
                    alignment=neutral
                [/filter_wml]
            [/or]
        [/filter]
        apply_to=hitpoints
        increase_total=1
        heal_full=yes
    [/effect]
    [modify_unit]
        [filter]
            x,y=$unit.x,$unit.y
            [not]
                [filter_wml]
                    [modifications]
                        [trait]
                            id=fearless
                        [/trait]
                    [/modifications]
                [/filter_wml]
                [or]
                    [filter_wml]
                        alignment=neutral
                    [/filter_wml]
                [/or]
            [/not]
        [/filter]
        {TRAIT_FEARLESS}
        role=wct_fearless
    [/modify_unit]
[/chance]
#enddef

#define WCT_CHANCE_SP CHANCE RANGE SPECIAL
[chance]
    value={CHANCE}
    info={STR_{RANGE}}+": "+{STR_{SPECIAL}}
    [effect]
        [filter]
            [filter_wml]
                [attack]
                    range={STR_ID_{RANGE}}
                    [specials]
                        {WEAPON_SPECIAL_{SPECIAL}}
                    [/specials]
                [/attack]
            [/filter_wml]
        [/filter]
        apply_to=hitpoints
        increase_total=1
        heal_full=yes
    [/effect]
    [effect]
        apply_to=attack
        range={STR_ID_{RANGE}}
        remove_specials={STR_ID_{SPECIAL}}
        [set_specials]
            mode=append
            {WEAPON_SPECIAL_{SPECIAL}}
        [/set_specials]
    [/effect]
[/chance]
#enddef

#define WCT_CHANCE_BACKSTAB CHANCE
[chance]
    value={CHANCE}
    info={STR_BACKSTAB}
    [effect]
        [filter]
            [filter_wml]
                [attack]
                    [specials]
                        {WEAPON_SPECIAL_BACKSTAB}
                    [/specials]
                [/attack]
            [/filter_wml]
        [/filter]
        apply_to=hitpoints
        increase_total=1
        heal_full=yes
    [/effect]
    [effect]
        apply_to=attack
        remove_specials=backstab
        [set_specials]
            mode=append
            {WEAPON_SPECIAL_BACKSTAB}
        [/set_specials]
    [/effect]
[/chance]
#enddef

#define WCT_CHANCE_ABILITY CHANCE ABILITY
[chance]
    value={CHANCE}
    info={STR_{ABILITY}}
    [effect]
        [filter]
            ability={STR_ID_{ABILITY}}
        [/filter]
        apply_to=hitpoints
        increase_total=1
        heal_full=yes
    [/effect]
    [effect]
        apply_to=new_ability
        [abilities]
            {ABILITY_{ABILITY}}
        [/abilities]
    [/effect]
[/chance]
#enddef

#define WCT_FEEDING
[effect]
    apply_to=new_ability
    [abilities]
        [dummy]
            id=feeding
            name= {STR_FEEDING}
            female_name= {STR_FEEDING}
            description= {STR_FEEDING_DESCRIPTION}
        [/dummy]
    [/abilities]
[/effect]
[event]
    id=ability_feeding_die
    name=die
    first_time_only=no
    [filter]
        [not]
            [filter_wml]
                [status]
                    not_living="yes"
                [/status]
            [/filter_wml]
        [/not]
    [/filter]
    [filter_second]
        ability=feeding
    [/filter_second]
    [unstore_unit]
        variable=second_unit
        {COLOR_HEAL}
        text= {STR_FEEDING_EFFECT}
        find_vacant=no
    [/unstore_unit]
    [object]
        silent=yes
        duration=forever
        [filter]
            x,y=$x2,$y2
        [/filter]
        [effect]
            apply_to=hitpoints
            increase_total=1
            increase=1
        [/effect]
    [/object]
[/event]
#enddef

#define WCT_CHANCE_FEEDING CHANCE
[chance]
    value={CHANCE}
    info={STR_FEEDING}
    [effect]
        [filter]
            ability=feeding
        [/filter]
        apply_to=hitpoints
        increase_total=1
        heal_full=yes
    [/effect]
    {WCT_FEEDING}
[/chance]
#enddef

#define WCT_LEADERSHIP_X LEVEL
[effect]
    [filter]
        level={LEVEL}
    [/filter]
    apply_to=new_ability
    [abilities]
        {ABILITY_LEADERSHIP_LEVEL_{LEVEL}}
    [/abilities]
[/effect]
#enddef

#define WCT_CHANCE_LEADERSHIP CHANCE
[chance]
    value={CHANCE}
    info={STR_LEADERSHIP}
    [effect]
        [filter]
            ability=leadership
        [/filter]
        apply_to=hitpoints
        increase_total=1
        heal_full=yes
    [/effect]
    {WCT_LEADERSHIP_X 1}
    {WCT_LEADERSHIP_X 2}
    {WCT_LEADERSHIP_X 3}
    {WCT_LEADERSHIP_X 4}
[/chance]
#enddef

#define WCT_CHANCE_DAMAGE CHANCE RANGE BOOST
[chance]
    value={CHANCE}
    info={STR_{RANGE}}+": +{BOOST} "+{STR_DAMAGE}
    [effect]
        apply_to=attack
        range={STR_ID_{RANGE}}
        increase_damage={BOOST}
    [/effect]
[/chance]
#enddef

#define WCT_CHANCE_DAMAGE_PER_LEVEL CHANCE RANGE
[chance]
    value={CHANCE}
    info={STR_{RANGE}}+": +1 "+{STR_DAMAGE}+" "+{STR_PER_LEVEL}
    [effect]
        apply_to=attack
        range={STR_ID_{RANGE}}
        increase_damage=1
        times=per level
    [/effect]
[/chance]
#enddef

#define WCT_CHANCE_DAMAGE_PER_CENT CHANCE RANGE BOOST
[chance]
    value={CHANCE}
    info={STR_{RANGE}}+": +{BOOST}% "+{STR_DAMAGE}
    [effect]
        apply_to=attack
        range={STR_ID_{RANGE}}
        increase_damage={BOOST}%
    [/effect]
[/chance]
#enddef

#define WCT_CHANCE_HP CHANCE HP
[chance]
    value={CHANCE}
    info="+{HP} "+{STR_HITPOINTS}
    [effect]
        apply_to=hitpoints
        increase_total={HP}
        heal_full=yes
    [/effect]
[/chance]
#enddef

#define WCT_CHANCE_HP_PER_LEVEL CHANCE HP
[chance]
    value={CHANCE}
    info="+{HP} "+{STR_HITPOINTS}+" "{STR_PER_LEVEL}
    [effect]
        apply_to=hitpoints
        times=per level
        increase_total={HP}
        heal_full=yes
    [/effect]
[/chance]
#enddef

#define WCT_CHANCE_HP_PER_CENT CHANCE
[chance]
    value={CHANCE}
    info="+10% "+{STR_HITPOINTS}
    [effect]
        apply_to=hitpoints
        increase_total=10%
        heal_full=yes
    [/effect]
[/chance]
#enddef

#define WCT_CHANCE_XP CHANCE VALUE
[chance]
    value={CHANCE}
    info="{VALUE} "+{STR_EXPERIENCE}
    [effect]
        apply_to=max_experience
        increase={VALUE}
    [/effect]
[/chance]
#enddef

#define WCT_CHANCE_URBAN_DEFENSE CHANCE
[chance]
    value={CHANCE}
    info={STR_VILLAGE}+"/"+{STR_CASTLE}+": +5 "+{STR_DEFENSE}
    [effect]
        apply_to=defense
        replace=false
        [defense]
            village=-5
            castle=-5
        [/defense]
    [/effect]
[/chance]
#enddef

#define WCT_WILD_DEFENSE TERRAIN BONUS_D
[effect]
    apply_to=defense
    replace=false
    [defense]
        {STR_ID_{TERRAIN}}=-{BONUS_D}
    [/defense]
[/effect]
[effect]
    apply_to=movement_costs
    replace=true
    [movement_costs]
        {STR_ID_{TERRAIN}}=1
    [/movement_costs]
[/effect]
#enddef

#define WCT_CHANCE_RANGER_SP CHANCE TERRAIN BONUS_D DMG_TYPE BONUS_R
[chance]
    value={CHANCE}
    info={STR_{TERRAIN}}+": +"+{BONUS_D}+" "+{STR_DEFENSE}+{STR_AND}+{STR_FULL_MOVEMENT}+", +"+{BONUS_R}+{STR_RESISTANCE}+{STR_{DMG_TYPE}}
    {WCT_WILD_DEFENSE {TERRAIN} {BONUS_D}}
    [effect]
        apply_to=resistance
        replace=false
        [resistance]
            {STR_ID_{DMG_TYPE}}=-{BONUS_R}
        [/resistance]
    [/effect]
[/chance]
#enddef

#define WCT_CHANCES_RANGER_TERRAIN_SPECIALS CHANCE GRADE
{WCT_CHANCE_RANGER_SP {CHANCE} FOREST "$(5+{GRADE})" PIERCE "$(7+{GRADE})"}
{WCT_CHANCE_RANGER_SP {CHANCE} HILLS "$(5+{GRADE})" IMPACT "$(7+{GRADE})"}
{WCT_CHANCE_RANGER_SP {CHANCE} SWAMP "$(5+{GRADE})" BLADE "$(7+{GRADE})"}
{WCT_CHANCE_RANGER_SP {CHANCE} SAND "$(5+{GRADE})" FIRE "$(7+{GRADE})"}
{WCT_CHANCE_RANGER_SP {CHANCE} FROZEN "$(8+2*{GRADE}+{GRADE}/3)" COLD "$(5+5*{GRADE})"}
#enddef

#define WCT_CHANCES_DARK_DEFENSES CHANCE
[chance]
    value={CHANCE}
    info={STR_CAVE}+": +10 "+{STR_DEFENSE}+{STR_AND}+{STR_FULL_MOVEMENT}
    {WCT_WILD_DEFENSE CAVE 10}
[/chance]
[chance]
    value={CHANCE}
    info={STR_MUSHROOM}+": +10 "+{STR_DEFENSE}+{STR_AND}+{STR_FULL_MOVEMENT}
    {WCT_WILD_DEFENSE MUSHROOM 10}
[/chance]
#enddef

#define WCT_CHANCE_MOVEMENT_DEFENSE CHANCE
[chance]
    value={CHANCE}
    info="+"+{STR_MOVES}+" "+{STR_DEFENSE}
    [event]
        id=wct_movement_boost_defenses
        name=wct_movement_boost_defenses
        first_time_only=no
        [object]
            duration=forever
            silent=yes
            [filter]
                x,y=$unit.x,$unit.y
            [/filter]
            [effect]
                [filter]
                    level=$unit.level
                [/filter]
                apply_to=defense
                replace=false
                [defense]
                    fungus=-$unit.max_moves
                    cave=-$unit.max_moves
                    deep_water=-$unit.max_moves
                    shallow_water=-$unit.max_moves
                    swamp_water=-$unit.max_moves
                    flat=-$unit.max_moves
                    sand=-$unit.max_moves
                    forest=-$unit.max_moves
                    hills=-$unit.max_moves
                    mountains=-$unit.max_moves
                    village=-$unit.max_moves
                    castle=-$unit.max_moves
                    frozen=-$unit.max_moves
                    unwalkable=-$unit.max_moves
                    reef=-$unit.max_moves
                [/defense]
            [/effect]
        [/object]
        [store_unit]
            variable=unit
            [filter]
                x,y=$unit.x,$unit.y
            [/filter]
        [/store_unit]
    [/event]
    {WCT_ARTIFACT_FIRE_EVENT movement_boost defenses}
[/chance]
#enddef

#define WCT_CHANCE_OPTIONAL_CHARGE CHANCE
[chance]
    value={CHANCE}
    info={STR_MELEE}+": "+{STR_OPTIONAL_CHARGE}
    [effect]
        apply_to=attack
        range=melee
        remove_specials=charge
    [/effect]
    [event]
        id=wct_optional_charge_attacks
        name=wct_optional_charge_attacks
        first_time_only=no
        [set_variables]
            name=temp_attack
            to_variable=unit.attack
        [/set_variables]
        {FOREACH temp_attack attack_i}
            [if]
                [variable]
                    name=temp_attack[$attack_i].range
                    equals=melee
                [/variable]
            [then]
                {VARIABLE temp_attack[$attack_i].name optional_charge_$unit.attack[$attack_i].name}
                [set_variables]
                    mode=append
                    name=temp_attack[$attack_i].specials.damage
                    [value]
                        id=charge
                        name= {STR_CHARGE}
                        description= {STR_CHARGE_DESCRIPTION}
                        multiply=2
                        apply_to=both
                        active_on=offense
                    [/value]
                [/set_variables]
            [/then]
            [/if]
        {NEXT attack_i}
        {FOREACH temp_attack attack_i}
            [if]
                [variable]
                    name=temp_attack[$attack_i].range
                    equals=ranged
                [/variable]
            [then]
                {CLEAR_VARIABLE temp_attack[$attack_i]}
                {VARIABLE_OP attack_i add -1}
            [/then]
            [/if]
        {NEXT attack_i}
        [set_variables]
            mode=append
            name=unit.attack
            to_variable=temp_attack
        [/set_variables]
        {CLEAR_VARIABLE temp_attack}
        [unstore_unit]
            variable=unit
        [/unstore_unit]
    [/event]
    {WCT_ARTIFACT_FIRE_EVENT optional_charge attacks}
[/chance]
#enddef

#define WCT_CHANCE_ARCANE_BOOST CHANCE RANGE 
[chance]
    value={CHANCE}
    info={STR_{RANGE}}+": "+{STR_ARCANE}+{STR_AND}+"+25% "+{STR_DAMAGE}
    [effect]
        [filter]
            [filter_wml]
                [attack]
                    range={STR_ID_{RANGE}}
                    type=arcane
                [/attack]
            [/filter_wml]
        [/filter]
        apply_to=hitpoints
        increase_total=1
        heal_full=yes
    [/effect]
    [effect]
        apply_to=attack
        range={STR_ID_{RANGE}}
        set_type=arcane
        increase_damage=25%
    [/effect]
[/chance]
#enddef
